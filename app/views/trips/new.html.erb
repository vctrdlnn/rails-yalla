<div class="trip-new-page">
  <!-- Hero Section -->
  <section class="trip-new-hero">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1>Where to next?</h1>
      <p>Plan your perfect trip in minutes</p>
    </div>
  </section>

  <!-- Form Section -->
  <section class="trip-new-form-section">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-sm-offset-2 col-sm-8 col-md-offset-3 col-md-6">
          <div class="trip-form-card">
            <%= simple_form_for @trip, html: { class: 'trip-new-form' } do |f| %>
              <%= f.input :country, as: :hidden %>
              <%= f.input :photo_cache, as: :hidden %>

              <!-- City Input -->
              <div class="form-section">
                <%= f.input :city,
                  placeholder: "e.g. Paris, Tokyo, New York...",
                  label: "Destination",
                  input_html: { class: 'form-input-lg', autofocus: true }
                %>
              </div>

              <!-- Title Input -->
              <div class="form-section">
                <%= f.input :title,
                  placeholder: "Give your trip a name",
                  label: "Trip name",
                  input_html: { class: 'form-input-lg' }
                %>
              </div>

              <!-- Days Selection -->
              <div class="form-section">
                <label class="control-label">How many days?</label>
                <div class="days-selector">
                  <% (1..7).each do |day| %>
                    <label class="day-option <%= 'selected' if day == 3 %>">
                      <input type="radio" name="trip[nb_days]" value="<%= day %>" <%= 'checked' if day == 3 %>>
                      <span><%= day %></span>
                    </label>
                  <% end %>
                </div>
              </div>

              <!-- Invite Friends -->
              <div class="form-section">
                <div class="form-group invite-friends-group">
                  <label class="control-label">Invite friends</label>
                  <div class="invite-input-wrapper">
                    <div class="email-chips" id="email-chips"></div>
                    <input type="email"
                           id="invite-email-input"
                           class="form-control"
                           placeholder="Enter email and press Enter">
                  </div>
                  <input type="hidden" name="invite_emails" id="invite-emails-hidden" value="">
                  <p class="help-block">Invite collaborators to help plan this trip</p>
                </div>
              </div>

              <!-- Cover Photo -->
              <div class="form-section">
                <label class="control-label">Cover photo</label>

                <!-- Photo Selection Buttons (shown initially) -->
                <div class="photo-choice-buttons" id="photo-choice-buttons">
                  <button type="button" class="btn-photo-choice" id="btn-find-web">
                    <i class="fa fa-camera"></i> Get from Unsplash
                  </button>
                  <button type="button" class="btn-photo-choice" id="btn-upload-own">
                    <i class="fa fa-upload"></i> Upload your own
                  </button>
                </div>

                <!-- Loading indicator -->
                <div class="photo-loading" id="photo-loading" style="display: none;">
                  <i class="fa fa-spinner fa-spin"></i> Finding a photo...
                </div>

                <!-- Photo Preview (shown after selection) -->
                <div class="photo-preview-container" id="photo-preview-container" style="display: none;">
                  <div class="photo-preview-wrapper">
                    <img id="photo-preview-img" src="" alt="Cover photo preview">
                    <div class="photo-preview-actions">
                      <button type="button" class="btn-photo-action" id="btn-refresh-photo" title="Try another photo">
                        <i class="fa fa-refresh"></i>
                      </button>
                      <button type="button" class="btn-photo-action" id="btn-change-photo" title="Change photo">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <p class="photo-credit" id="photo-credit"></p>
                </div>

                <!-- Custom Upload (shown when "Upload your own" is clicked) -->
                <div class="custom-upload-container" id="custom-upload-container" style="display: none;">
                  <%= f.input :photo,
                    label: false,
                    wrapper: false,
                    input_html: { id: 'custom-photo-input' }
                  %>
                  <button type="button" class="btn-cancel-upload" id="btn-cancel-upload">Cancel</button>
                </div>

                <!-- Hidden field for Unsplash URL -->
                <input type="hidden" name="trip[remote_photo_url]" id="remote-photo-url" value="">
              </div>

              <!-- Optional Section Toggle -->
              <div class="form-divider optional-toggle" id="optional-toggle">
                <span><i class="fa fa-chevron-down toggle-icon"></i> Optional details</span>
              </div>

              <div class="form-section optional-section" id="optional-section" style="display: none;">
                <!-- Category Selection -->
                <%= f.input :category,
                  as: :select,
                  collection: ["Discovery", "Lovers", "Business", "Friends", "Bachelor", "Family", "Cultural"],
                  selected: "Discovery",
                  include_blank: false,
                  label: "Trip type"
                %>

                <%= f.input :description,
                  as: :text,
                  placeholder: "What's this trip about?",
                  label: "Description",
                  input_html: { rows: 3 }
                %>

                <%= f.input :start_date,
                  placeholder: "Select a date",
                  label: "Start date",
                  input_html: { value: @trip.start_date&.strftime("%-d %b, %Y") }
                %>

                <%= f.input :public,
                  required: false,
                  label: "Make this trip public",
                  hint: "Public trips can be discovered by other travelers"
                %>
              </div>

              <!-- Submit Button -->
              <div class="form-section">
                <%= f.button :submit, "Start Planning â†’", class: "btn-submit" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<% content_for (:js) do %>
  <script>
    $(function() {
      // Datepicker for start date
      $("#trip_start_date").datepicker({
        showButtonPanel: true,
        dateFormat: "d M, yy",
        minDate: 0
      });

      // Days selector interaction
      $(".day-option").on("click", function() {
        $(".day-option").removeClass("selected");
        $(this).addClass("selected");
      });

      // Optional section toggle
      $("#optional-toggle").on("click", function() {
        var $section = $("#optional-section");
        var $icon = $(this).find(".toggle-icon");
        $section.slideToggle(200);
        $icon.toggleClass("fa-chevron-down fa-chevron-up");
      });

      // Email chips for invite friends
      var emails = [];
      var $input = $("#invite-email-input");
      var $chips = $("#email-chips");
      var $hidden = $("#invite-emails-hidden");

      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function updateHiddenField() {
        $hidden.val(emails.join(","));
      }

      function addEmail(email) {
        email = email.trim().toLowerCase();
        if (email && isValidEmail(email) && emails.indexOf(email) === -1) {
          emails.push(email);
          var $chip = $('<span class="email-chip">' +
            '<span class="email-text">' + email + '</span>' +
            '<button type="button" class="chip-remove" data-email="' + email + '">&times;</button>' +
          '</span>');
          $chips.append($chip);
          updateHiddenField();
          return true;
        }
        return false;
      }

      function removeEmail(email) {
        var index = emails.indexOf(email);
        if (index > -1) {
          emails.splice(index, 1);
          updateHiddenField();
        }
      }

      $input.on("keydown", function(e) {
        if (e.key === "Enter" || e.key === ",") {
          e.preventDefault();
          if (addEmail($input.val())) {
            $input.val("");
          }
        }
      });

      $input.on("blur", function() {
        if ($input.val()) {
          if (addEmail($input.val())) {
            $input.val("");
          }
        }
      });

      $chips.on("click", ".chip-remove", function() {
        var email = $(this).data("email");
        removeEmail(email);
        $(this).parent().remove();
      });

      // Cover photo selection
      var $cityInput = $("#trip_city");
      var $choiceButtons = $("#photo-choice-buttons");
      var $loading = $("#photo-loading");
      var $previewContainer = $("#photo-preview-container");
      var $previewImg = $("#photo-preview-img");
      var $photoCredit = $("#photo-credit");
      var $remoteUrl = $("#remote-photo-url");
      var $customUpload = $("#custom-upload-container");
      var $customInput = $("#custom-photo-input");
      var currentPhotoIndex = 0;

      function fetchUnsplashPhoto(index) {
        var city = $cityInput.val().trim();
        if (!city || city.length < 2) {
          alert("Please enter a destination first");
          return;
        }

        $choiceButtons.hide();
        $previewContainer.hide();
        $loading.show();

        $.ajax({
          url: '/unsplash_photo',
          data: { query: city, index: index || 0 },
          dataType: 'json',
          success: function(data) {
            $loading.hide();
            if (data.url) {
              // Preload image
              var img = new Image();
              img.onload = function() {
                $previewImg.attr("src", data.url);
                // Auto-select the photo
                $remoteUrl.val(data.url);
                // Show credit
                if (data.photographer) {
                  $photoCredit.html(
                    'Photo by <a href="' + data.photographer_url + '?utm_source=yala&utm_medium=referral" target="_blank">' +
                    data.photographer + '</a> on <a href="https://unsplash.com/?utm_source=yala&utm_medium=referral" target="_blank">Unsplash</a>'
                  );
                }
                $previewContainer.fadeIn(200);
              };
              img.onerror = function() {
                $choiceButtons.show();
                alert("Could not load the photo. Please try again.");
              };
              img.src = data.url;
            } else {
              $choiceButtons.show();
              alert("No photos found for this destination.");
            }
          },
          error: function(xhr) {
            $loading.hide();
            $choiceButtons.show();
            console.log("Unsplash error:", xhr.responseJSON);
            alert("Could not find a photo. Please try again or upload your own.");
          }
        });
      }

      // "Get from Unsplash" button
      $("#btn-find-web").on("click", function() {
        currentPhotoIndex = 0;
        fetchUnsplashPhoto(0);
      });

      // "Upload your own" button
      $("#btn-upload-own").on("click", function() {
        $choiceButtons.hide();
        $customUpload.show();
      });

      // Cancel upload
      $("#btn-cancel-upload").on("click", function() {
        $customInput.val("");
        $customUpload.hide();
        $choiceButtons.show();
      });

      // When custom file is selected, show preview
      $customInput.on("change", function() {
        if (this.files && this.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            $previewImg.attr("src", e.target.result);
            $remoteUrl.val(""); // Clear remote URL since we're using uploaded file
            $photoCredit.html("Your uploaded photo");
            $customUpload.hide();
            $previewContainer.fadeIn(200);
          };
          reader.readAsDataURL(this.files[0]);
        }
      });

      // Refresh photo (try another from web)
      $("#btn-refresh-photo").on("click", function() {
        currentPhotoIndex++;
        fetchUnsplashPhoto(currentPhotoIndex);
      });

      // Change photo (go back to choice buttons)
      $("#btn-change-photo").on("click", function() {
        $previewContainer.hide();
        $remoteUrl.val("");
        $customInput.val("");
        currentPhotoIndex = 0;
        $choiceButtons.show();
      });
    });
  </script>
<% end %>
