<% content_for(:title) do %>
  <%= @trip.title %> - Edit
<% end %>
<% @disable_footer = true %>
<% trip_icons = set_day_icon(@trip.trip_days) %>
<div class="trip-edit-wrapper">
  <!-- Mobile Tab Navigation -->
  <div class="mobile-tabs">
    <button class="mobile-tab active" data-tab="plan-panel">
      <i class="fa fa-list"></i> Plan
    </button>
    <button class="mobile-tab" data-tab="days-panel">
      <i class="fa fa-calendar"></i> Days
    </button>
    <button class="mobile-tab" data-tab="map-panel">
      <i class="fa fa-map"></i> Map
    </button>
  </div>

  <div class="container-fuid heigth100">
    <div class="row-fluid text-center heigth100">

      <!-- AUTRES -->
      <div id="plan-panel" class="col-xs-8 col-sm-2 heigth100 mobile-panel active">
      <!-- Activities not assigned + Add new activity module -->
        <p>Unassigned(<%= image_tag trip_icons[0], class: "avatar-mini" %>)</p>
        <div class="row">
          <div class="col-xs-12">
            <%= render 'activities/form_new_establishment_from_trip', activity: @activity, trip: @trip, main_categories: @main_categories %>
            <!-- <button type="button" class="btn btn-g width100 no-h-padding" data-toggle="modal" data-target="#modal_establishment">Add a specific place</button> -->
          </div>
            <!--  <div class="col-xs-12">
            <button type="button" class="btn btn-g width100 no-h-padding" data-toggle="modal" data-target="#modal_category">Add an activity</button>
          </div> -->
      </div>
        <div id="grid-0" class="activity-grid works-hover-w sortable accordion heigth80">
          <% @trip.activities.where(trip_day: nil).order(index: :asc).each do |act| %>
            <%= render 'activities/card_activity_index', activity: act %>
          <% end %>
        </div>
      </div>

      <!-- LE VOYAGE JOUR PAR JOUR -->
      <div id="days-panel" class="col-xs-12 col-sm-6 heigth100 mobile-panel">
        <!-- Trip Days and Itiniraries -->
        <p class="font-alt"><%= @trip.title %></p>
        <div class="trip-days-scroll-wrapper heigth90">
          <div class="trip-days-scroll-container side-brd-grey">
            <% @trip.trip_days.each do |td| %>
              <div class="trip-day heigth100">
                <p><%= td.title %>(<%= image_tag trip_icons[td.id], class: "avatar-mini" %>)</p>
                <div id="grid-<%= td.id %>" class="activity-grid works-hover-w sortable accordion heigth90">
                  <% @trip.activities.where(trip_day: td).order(index: :asc).each do |act| %>
                    <%= render 'activities/card_activity_index', activity: act %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <!-- /LE VOYAGE JOUR PAR JOUR -->

      <!-- AUTRES -->
      <div id="map-panel" class="col-xs-12 col-sm-4 heigth100 mobile-panel">

        <!-- BOUTONS -->
        <div class="buttons margined" style="width: 100%;">
          <div class="row">
            <div class="col-xs-3 mini-h-padding">
              <%= button_to make_my_day_trip_path(@trip), class: "btn btn-success  width100 text-center no-h-padding", method: :put do %>
                <span class="icon-genius"></span>Make my day
              <% end %>
            </div>
            <div class="col-xs-3 mini-h-padding">
              <%= button_to trip_path(@trip), class: "btn btn-info width100  text-center no-h-padding", method: :get do %>
                <span class="icon-printer"></span> Print
              <% end %>
            </div>
            <div class="col-xs-3 mini-h-padding">
              <%= button_to properties_trip_path(@trip), class: "btn btn-info width100  text-center no-h-padding", method: :get do %>
                <span class="icon-pencil"></span> Manage
              <% end %>
            </div>
            <div class="col-xs-3 mini-h-padding">
              <%= button_to trip_path(@trip), class: "btn btn-danger width100 text-center no-h-padding", method: :delete, data: {confirm: "CAUTION !!! THIS IS NOT REVERSIBLE - Are you sure you want to delete the entire trip?"} do %>
                <i class="fa fa-trash-o fa-lg" aria-hidden="true"></i>DELETE
              <% end %>
            </div>
          </div>
        </div>

        <!-- Map, to do, references, etc... -->
        <div class="map_container" style="width: 100%; height: 50%;">
          <%= render 'shared/maps', map_hash: set_map_hash(@trip.activities, trip_icons) %>
        </div>

        <!-- Description of the trip to edit -->
        <div class="other_container brd-lightgry" style="width: 100%; height: 30%;">
          <p><span class="font-alt">Description:</span></p>
          <p><%= @trip.description %></p>
          <span id="city_coordinates" style="display:none;"><%= "#{@trip.lat}|#{@trip.lon}" %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for(:js) do %>
  <script>
    $(document).ready(function() {
      // TODO Check safety!!!
      var AUTH_TOKEN = $('meta[name=csrf-token]').attr('content');

      // Horizontal drag-to-scroll for trip days
      var scrollContainer = document.querySelector('.trip-days-scroll-container');
      var scrollWrapper = document.querySelector('.trip-days-scroll-wrapper');

      // Check if content overflows and add indicator class (defined outside if block for scope)
      function checkOverflow() {
        if (scrollContainer && scrollWrapper) {
          if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
            scrollWrapper.classList.add('has-scroll');
          } else {
            scrollWrapper.classList.remove('has-scroll');
          }
        }
      }

      if (scrollContainer) {
        var isDown = false;
        var startX;
        var scrollLeft;

        checkOverflow();
        window.addEventListener('resize', checkOverflow);

        // Mouse drag scrolling
        scrollContainer.addEventListener('mousedown', function(e) {
          // Don't interfere with activity card dragging
          if ($(e.target).closest('.activity-item').length) return;

          isDown = true;
          scrollContainer.style.cursor = 'grabbing';
          startX = e.pageX - scrollContainer.offsetLeft;
          scrollLeft = scrollContainer.scrollLeft;
        });

        scrollContainer.addEventListener('mouseleave', function() {
          isDown = false;
          scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mouseup', function() {
          isDown = false;
          scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mousemove', function(e) {
          if (!isDown) return;
          e.preventDefault();
          var x = e.pageX - scrollContainer.offsetLeft;
          var walk = (x - startX) * 1.5; // Scroll speed multiplier
          scrollContainer.scrollLeft = scrollLeft - walk;
        });

        // Set initial cursor style
        scrollContainer.style.cursor = 'grab';
      }

      // Mobile Tab Navigation
      $('.mobile-tab').on('click', function() {
        var targetPanel = $(this).data('tab');

        // Update active tab
        $('.mobile-tab').removeClass('active');
        $(this).addClass('active');

        // Update active panel
        $('.mobile-panel').removeClass('active');
        $('#' + targetPanel).addClass('active');

        // Re-check scroll overflow when switching to days panel
        if (targetPanel === 'days-panel') {
          setTimeout(checkOverflow, 100);
        }

        // Trigger map resize when switching to map panel
        if (targetPanel === 'map-panel' && typeof google !== 'undefined' && window.map) {
          setTimeout(function() {
            google.maps.event.trigger(window.map, 'resize');
          }, 100);
        }
      });

      // Set initial active panel on mobile
      if ($(window).width() < 768) {
        $('.mobile-panel').removeClass('active');
        $('#days-panel').addClass('active');
        $('.mobile-tab').removeClass('active');
        $('.mobile-tab[data-tab="days-panel"]').addClass('active');
      }

      // SORTING with enhanced visual feedback
      // Define all lists you can connect together
      var connectable_lists = "#grid-0";
      var days = $('.trip-day .sortable');
      for (var i = 0; i < days.length; i++) {
         connectable_lists = connectable_lists.concat(", #" + days[i].id);
      }

      // Action history for undo functionality
      var actionHistory = [];
      var currentToast = null;

      $( connectable_lists ).sortable({
          connectWith: ".sortable",
          delay: 150,        // 150ms delay to distinguish tap from drag on mobile
          distance: 10,      // 10px threshold before drag starts
          placeholder: "placeholder-highlight ui-corner-all",
          handle: ".activity-item-header",
          cancel: ".activity-item-toggle",
          cursor: "grabbing",
          opacity: 0.9,
          revert: 100,
          // Store original position when starting drag
          start: function(event, ui) {
            ui.item.data('originalParent', ui.item.parent().attr('id'));
            ui.item.data('originalIndex', ui.item.index());
            ui.item.addClass('dragging');
          },
          // Highlight target column when dragging over
          over: function(event, ui) {
            $(this).addClass('drag-over');
            $(this).closest('.trip-day').addClass('drag-over-day');
          },
          // Remove highlight when leaving column
          out: function(event, ui) {
            $(this).removeClass('drag-over');
            $(this).closest('.trip-day').removeClass('drag-over-day');
          },
          stop: function(event, ui) {
            // Clean up all drag classes
            $('.drag-over').removeClass('drag-over');
            $('.drag-over-day').removeClass('drag-over-day');
            ui.item.removeClass('dragging');
            // Save position with optimistic UI
            savePosition(event, ui);
          }
      });

      $( ".accordion" ).accordion({
        header: "> div > div.activity-item-header",
        collapsible: true,
        heightStyle: "content",
        active: false,
        icons: false
      });

      // Toast notification helper
      function showToast(message, type, showUndo, undoCallback) {
        // Remove existing toast
        if (currentToast) {
          currentToast.remove();
        }

        var toast = $('<div class="save-toast ' + type + '">' +
          '<span>' + message + '</span>' +
          (showUndo ? '<button class="undo-btn">Undo</button>' : '') +
          '</div>');

        if (showUndo && undoCallback) {
          toast.find('.undo-btn').on('click', function() {
            undoCallback();
            toast.remove();
          });
        }

        $('body').append(toast);
        currentToast = toast;

        // Auto-hide after 4 seconds
        setTimeout(function() {
          toast.fadeOut(300, function() { $(this).remove(); });
        }, 4000);
      }

      function savePosition(event, ui) {
        var activity_id = ui.item[0].id.split("-").pop();
        var newDay = ui.item[0].parentElement.id.split("-").pop();
        var newIndex = $("#grid-" + newDay + " .activity-item").index(ui.item) + 1;
        var originalParent = ui.item.data('originalParent');
        var originalIndex = ui.item.data('originalIndex');

        var data = {
          activity: {
            trip_day_id: newDay,
            index: newIndex
          },
          authenticity_token: AUTH_TOKEN
        };

        // Show saving indicator
        showToast('Saving...', 'saving', false);

        $.ajax({
          type: 'PUT',
          url: '/activities/' + activity_id + '/change_position/',
          data: data,
          success: function(data) {
            console.log('index updated');

            // Store action for undo
            var undoAction = {
              activityId: activity_id,
              fromGrid: 'grid-' + newDay,
              fromIndex: newIndex - 1,
              toGrid: originalParent,
              toIndex: originalIndex
            };
            actionHistory.push(undoAction);

            // Show success with undo option
            showToast('Activity moved', 'success', true, function() {
              undoLastAction(undoAction);
            });

            $('#autoRefresh').click();
          },
          error: function(jqXHR) {
            console.error(jqXHR.responseText);
            showToast('Failed to save. Please try again.', 'error', false);

            // Rollback: move item back to original position
            var item = ui.item;
            var originalGrid = $('#' + originalParent);
            var items = originalGrid.children('.activity-item');

            if (originalIndex >= items.length) {
              originalGrid.append(item);
            } else {
              items.eq(originalIndex).before(item);
            }
          }
        });
      }

      function undoLastAction(action) {
        var item = $('#act-' + action.activityId);
        var targetGrid = $('#' + action.toGrid);

        if (item.length === 0) {
          console.error('Undo failed: activity not found', action.activityId);
          showToast('Undo failed: activity not found', 'error', false);
          return;
        }

        if (targetGrid.length === 0) {
          console.error('Undo failed: target grid not found', action.toGrid);
          showToast('Undo failed: target not found', 'error', false);
          return;
        }

        // Move item back visually
        var items = targetGrid.children('.activity-item');
        if (action.toIndex >= items.length) {
          targetGrid.append(item);
        } else if (action.toIndex <= 0) {
          targetGrid.prepend(item);
        } else {
          items.eq(action.toIndex).before(item);
        }

        // Save the undo to server
        var newDay = action.toGrid.split("-").pop();
        var data = {
          activity: {
            trip_day_id: newDay,
            index: action.toIndex + 1
          },
          authenticity_token: AUTH_TOKEN
        };

        showToast('Undoing...', 'saving', false);

        $.ajax({
          type: 'PUT',
          url: '/activities/' + action.activityId + '/change_position/',
          data: data,
          success: function() {
            showToast('Undo successful', 'success', false);
            $('#autoRefresh').click();
          },
          error: function() {
            showToast('Undo failed', 'error', false);
            // TODO: could rollback the visual change here
          }
        });
      }

      // =====================
      // INLINE EDITING
      // =====================

      // Double-click to start editing
      $(document).on('dblclick', '.editable-field', function(e) {
        e.stopPropagation();
        startEditing($(this));
      });

      function startEditing($field) {
        if ($field.hasClass('editing')) return;

        var $text = $field.find('.editable-text');
        var $input = $field.find('.editable-input');
        var originalValue = $text.text().trim();

        $field.addClass('editing');
        $text.hide();
        $input.val(originalValue).show().focus().select();

        // Store original value for cancel
        $input.data('original-value', originalValue);
      }

      function stopEditing($field, save) {
        var $text = $field.find('.editable-text');
        var $input = $field.find('.editable-input');
        var newValue = $input.val().trim();
        var originalValue = $input.data('original-value');
        var isTextarea = $field.hasClass('editable-textarea');

        $field.removeClass('editing');
        $input.hide();
        $text.show();

        if (save && newValue !== originalValue) {
          // For description, truncate display but save full value
          var displayValue = newValue;
          if (isTextarea && newValue.length > 80) {
            displayValue = newValue.substring(0, 80) + '...';
          }

          // Update text immediately (optimistic)
          $text.text(displayValue || (isTextarea ? '' : originalValue));

          // Save to server
          var activityId = $field.data('activity-id');
          var fieldName = $field.data('field');
          var data = { authenticity_token: AUTH_TOKEN, activity: {} };
          data.activity[fieldName] = newValue;

          showToast('Saving...', 'saving', false);

          $.ajax({
            type: 'PATCH',
            url: '/activities/' + activityId,
            data: data,
            success: function() {
              showToast('Saved', 'success', false);
            },
            error: function() {
              // Rollback on error
              $text.text(originalValue);
              showToast('Failed to save', 'error', false);
            }
          });
        } else {
          // Restore original value on cancel
          $text.text(originalValue);
        }
      }

      // Save on Enter, cancel on Escape
      $(document).on('keydown', '.editable-input', function(e) {
        var $field = $(this).closest('.editable-field');

        if (e.key === 'Enter') {
          e.preventDefault();
          stopEditing($field, true);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          stopEditing($field, false);
        }
      });

      // Save on blur (click outside)
      $(document).on('blur', '.editable-input', function() {
        var $field = $(this).closest('.editable-field');
        // Small delay to allow click events to fire first
        setTimeout(function() {
          if ($field.hasClass('editing')) {
            stopEditing($field, true);
          }
        }, 100);
      });

      // Prevent accordion toggle when clicking editable field
      $(document).on('click', '.editable-field', function(e) {
        e.stopPropagation();
      });

      // Single click for select fields (category dropdown)
      $(document).on('click', '.editable-select', function(e) {
        e.stopPropagation();
        if (!$(this).hasClass('editing')) {
          startEditing($(this));
        }
      });

      // Handle select change - save immediately
      $(document).on('change', '.editable-select .editable-input', function() {
        var $field = $(this).closest('.editable-field');
        var $text = $field.find('.editable-text');
        var $input = $(this);
        var newValue = $input.val();
        var newText = $input.find('option:selected').text();
        var activityId = $field.data('activity-id');
        var fieldName = $field.data('field');

        // Update text immediately
        $text.text(newText);
        $field.removeClass('editing');
        $input.hide();
        $text.show();

        // Save to server
        var data = { authenticity_token: AUTH_TOKEN, activity: {} };
        data.activity[fieldName] = newValue;

        showToast('Saving...', 'saving', false);

        $.ajax({
          type: 'PATCH',
          url: '/activities/' + activityId,
          data: data,
          success: function() {
            showToast('Saved', 'success', false);
            // Refresh to update category icon
            setTimeout(function() { location.reload(); }, 500);
          },
          error: function() {
            showToast('Failed to save', 'error', false);
          }
        });
      });

      // Photo upload handling
      $(document).on('change', '.photo-input', function() {
        var $input = $(this);
        var $field = $input.closest('.photo-field');
        var activityId = $field.data('activity-id');
        var file = this.files[0];

        if (!file) return;

        // Validate file type
        if (!file.type.match(/image.*/)) {
          showToast('Please select an image file', 'error', false);
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showToast('Image must be less than 5MB', 'error', false);
          return;
        }

        showToast('Uploading photo...', 'saving', false);

        // Create FormData for file upload
        var formData = new FormData();
        formData.append('activity[photo]', file);
        formData.append('authenticity_token', AUTH_TOKEN);

        $.ajax({
          type: 'PATCH',
          url: '/activities/' + activityId,
          data: formData,
          processData: false,
          contentType: false,
          success: function() {
            showToast('Photo uploaded', 'success', false);
            // Refresh to show new photo
            setTimeout(function() { location.reload(); }, 500);
          },
          error: function() {
            showToast('Failed to upload photo', 'error', false);
          }
        });
      });

      // Handle textarea Enter (Shift+Enter for new line, Enter to save)
      $(document).on('keydown', '.editable-textarea .editable-input', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          var $field = $(this).closest('.editable-field');
          stopEditing($field, true);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          var $field = $(this).closest('.editable-field');
          stopEditing($field, false);
        }
      });

      // =====================
      // KEYBOARD SHORTCUTS
      // =====================

      var selectedCard = null;

      // Global keyboard shortcuts (when not editing)
      $(document).on('keydown', function(e) {
        // Ignore if typing in an input/textarea
        if ($(e.target).is('input, textarea, select, [contenteditable]')) {
          return;
        }

        switch(e.key) {
          case 'n':
          case 'N':
            // Focus the establishment search field to add new activity
            e.preventDefault();
            $('#activity_est_establishment').focus();
            showToast('Add new activity...', 'saving', false);
            break;

          case 'Escape':
            // Deselect current card
            if (selectedCard) {
              $(selectedCard).removeClass('card-selected');
              selectedCard = null;
            }
            break;

          case 'ArrowDown':
          case 'j':
            e.preventDefault();
            navigateCards('down');
            break;

          case 'ArrowUp':
          case 'k':
            e.preventDefault();
            navigateCards('up');
            break;

          case 'ArrowLeft':
          case 'h':
            e.preventDefault();
            navigateCards('left');
            break;

          case 'ArrowRight':
          case 'l':
            e.preventDefault();
            navigateCards('right');
            break;

          case 'Enter':
            // Expand/collapse selected card
            if (selectedCard) {
              e.preventDefault();
              $(selectedCard).find('.activity-item-header').click();
            }
            break;

          case 'Delete':
          case 'Backspace':
            // Delete selected card (with confirmation)
            if (selectedCard && e.key === 'Delete') {
              e.preventDefault();
              var $deleteLink = $(selectedCard).find('a[data-method="delete"]');
              if ($deleteLink.length && confirm('Are you sure you want to delete this activity?')) {
                $deleteLink[0].click();
                selectedCard = null;
              }
            }
            break;

          case '?':
            // Show keyboard shortcuts help
            e.preventDefault();
            showKeyboardHelp();
            break;
        }
      });

      function navigateCards(direction) {
        var $cards = $('.activity-item:visible');
        if ($cards.length === 0) return;

        var currentIndex = selectedCard ? $cards.index($(selectedCard)) : -1;
        var newIndex = currentIndex;

        if (direction === 'down' || direction === 'up') {
          // Navigate within same column
          var $currentGrid = selectedCard ? $(selectedCard).closest('.activity-grid') : $('.activity-grid').first();
          var $gridCards = $currentGrid.find('.activity-item:visible');
          var gridIndex = selectedCard ? $gridCards.index($(selectedCard)) : -1;

          if (direction === 'down') {
            newIndex = gridIndex + 1;
            if (newIndex >= $gridCards.length) newIndex = 0;
          } else {
            newIndex = gridIndex - 1;
            if (newIndex < 0) newIndex = $gridCards.length - 1;
          }
          selectCard($gridCards.eq(newIndex));

        } else if (direction === 'left' || direction === 'right') {
          // Navigate between columns
          var $grids = $('.activity-grid:visible');
          var $currentGrid = selectedCard ? $(selectedCard).closest('.activity-grid') : null;
          var gridIndex = $currentGrid ? $grids.index($currentGrid) : -1;

          if (direction === 'right') {
            gridIndex = gridIndex + 1;
            if (gridIndex >= $grids.length) gridIndex = 0;
          } else {
            gridIndex = gridIndex - 1;
            if (gridIndex < 0) gridIndex = $grids.length - 1;
          }

          var $newGrid = $grids.eq(gridIndex);
          var $newCards = $newGrid.find('.activity-item:visible');
          if ($newCards.length > 0) {
            selectCard($newCards.first());
          }
        }
      }

      function selectCard($card) {
        // Deselect previous
        if (selectedCard) {
          $(selectedCard).removeClass('card-selected');
        }

        // Select new
        selectedCard = $card[0];
        $card.addClass('card-selected');

        // Scroll into view
        $card[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function showKeyboardHelp() {
        var helpHtml = '<div class="keyboard-help-overlay">' +
          '<div class="keyboard-help">' +
          '<h3>Keyboard Shortcuts</h3>' +
          '<ul>' +
          '<li><kbd>N</kbd> - Add new activity</li>' +
          '<li><kbd>↑</kbd><kbd>↓</kbd> or <kbd>J</kbd><kbd>K</kbd> - Navigate up/down</li>' +
          '<li><kbd>←</kbd><kbd>→</kbd> or <kbd>H</kbd><kbd>L</kbd> - Navigate between days</li>' +
          '<li><kbd>Enter</kbd> - Expand/collapse card</li>' +
          '<li><kbd>Delete</kbd> - Delete selected card</li>' +
          '<li><kbd>Esc</kbd> - Deselect card</li>' +
          '<li><kbd>?</kbd> - Show this help</li>' +
          '</ul>' +
          '<p>Click anywhere to close</p>' +
          '</div></div>';

        var $help = $(helpHtml);
        $('body').append($help);

        $help.on('click', function() {
          $(this).fadeOut(200, function() { $(this).remove(); });
        });
      }

      // Click to select card
      $(document).on('click', '.activity-item', function(e) {
        if (!$(e.target).closest('.editable-field, a, button, input, select').length) {
          selectCard($(this));
        }
      });

      // =====================
      // MOBILE MOVE FUNCTIONALITY
      // =====================

      // Highlight current location when dropdown opens
      $(document).on('show.bs.dropdown', '.mobile-move-action .dropdown', function() {
        var $card = $(this).closest('.activity-item');
        var currentDayId = $card.closest('.activity-grid').attr('id').split('-').pop();
        $(this).find('.move-to-day').removeClass('current-location');
        $(this).find('.move-to-day[data-day-id="' + currentDayId + '"]').addClass('current-location');
      });

      // Handle move-to-day click
      $(document).on('click', '.move-to-day', function(e) {
        e.preventDefault();
        var activityId = $(this).data('activity-id');
        var targetDayId = $(this).data('day-id');
        var $card = $('#act-' + activityId);
        var $sourceGrid = $card.closest('.activity-grid');
        var $targetGrid = $('#grid-' + targetDayId);

        // Don't move if already in target
        if ($sourceGrid.attr('id') === $targetGrid.attr('id')) {
          $(this).closest('.dropdown').find('.dropdown-toggle').dropdown('toggle');
          return;
        }

        // Store original position for undo
        var originalParent = $sourceGrid.attr('id');
        var originalIndex = $card.index();

        // Move card to target (optimistic UI)
        $targetGrid.append($card);

        // Close dropdown
        $(this).closest('.dropdown').find('.dropdown-toggle').dropdown('toggle');

        // Calculate new index
        var newIndex = $targetGrid.children('.activity-item').length;

        // Show saving indicator
        showToast('Moving activity...', 'saving', false);

        // Save to server
        $.ajax({
          type: 'PUT',
          url: '/activities/' + activityId + '/change_position/',
          data: {
            activity: { trip_day_id: targetDayId, index: newIndex },
            authenticity_token: AUTH_TOKEN
          },
          success: function() {
            // Store action for undo
            actionHistory.push({
              activityId: activityId,
              fromGrid: 'grid-' + targetDayId,
              fromIndex: newIndex - 1,
              toGrid: originalParent,
              toIndex: originalIndex
            });

            // Show success with undo option
            showToast('Activity moved', 'success', true, function() {
              undoLastAction(actionHistory[actionHistory.length - 1]);
            });

            $('#autoRefresh').click();
          },
          error: function() {
            // Rollback: move item back to original position
            var $originalGrid = $('#' + originalParent);
            var items = $originalGrid.children('.activity-item');

            if (originalIndex >= items.length) {
              $originalGrid.append($card);
            } else {
              items.eq(originalIndex).before($card);
            }

            showToast('Failed to move. Please try again.', 'error', false);
          }
        });
      });
    });
  </script>
<% end %>
