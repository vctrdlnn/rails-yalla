console.log('updating activity...')

// Close the modal properly
$('#myEditModal-<%= @activity.id %>').modal('hide');

// Find grid and position of activity BEFORE removing it
var old_act = $('#act-<%= @activity.id %>');
var parent_grid = old_act.closest('.activity-grid');
var grid_index = $('.activity-grid').index(parent_grid);
var act_index_in_grid = parent_grid.find('.activity-item').index(old_act);

console.log('Grid index:', grid_index, 'Activity index:', act_index_in_grid);

<% if @activity.errors.any? %>
  // Show errors in the modal
  console.log('Validation errors');
  alert('Error: <%= @activity.errors.full_messages.join(", ") %>');
<% else %>
  // Remove old element
  old_act.slideUp(200, function() {
    $(this).remove();

    // Create the updated activity card
    var edited_activity = $("<%= j render 'activities/card_activity_index', activity: @activity %>").hide();

    // Add to the DOM in the proper grid and at the proper position
    var target_grid = $('.activity-grid').eq(grid_index);
    var existing_items = target_grid.find('.activity-item');

    if (act_index_in_grid <= 0 || existing_items.length === 0) {
      target_grid.prepend(edited_activity);
    } else if (act_index_in_grid >= existing_items.length) {
      target_grid.append(edited_activity);
    } else {
      existing_items.eq(act_index_in_grid).before(edited_activity);
    }

    // Initialize accordion on the new card
    edited_activity.accordion({
      header: "> div > div.activity-item-header",
      collapsible: true,
      heightStyle: "content",
      active: false,
      icons: false
    });

    // Show with animation
    edited_activity.slideDown(200);

    console.log('Activity updated successfully');
  });
<% end %>
